{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "15024899299207188184"
    }
  },
  "parameters": {
    "app_name": {
      "type": "string",
      "defaultValue": "calc-template"
    },
    "storage_name": {
      "type": "string",
      "defaultValue": "calctemplatestorage"
    },
    "apiImage": {
      "type": "string"
    },
    "webImage": {
      "type": "string"
    },
    "registry": {
      "type": "string"
    },
    "registryUsername": {
      "type": "string"
    },
    "location_name": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "registryPassword": {
      "type": "secureString"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('app_name')]",
      "location": "[parameters('location_name')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "container-app-environment",
      "resourceGroup": "[parameters('app_name')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "app_name": {
            "value": "[parameters('app_name')]"
          },
          "location_name": {
            "value": "[parameters('location_name')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "4098917559689493134"
            }
          },
          "parameters": {
            "app_name": {
              "type": "string"
            },
            "location_name": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2020-03-01-preview",
              "name": "[parameters('app_name')]",
              "location": "[parameters('location_name')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                }
              }
            },
            {
              "type": "Microsoft.Web/kubeEnvironments",
              "apiVersion": "2021-02-01",
              "name": "[parameters('app_name')]",
              "location": "[parameters('location_name')]",
              "kind": "containerenvironment",
              "properties": {
                "type": "managed",
                "internalLoadBalancerEnabled": false,
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('app_name'))).customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('app_name')), '2020-03-01-preview').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('app_name'))]"
              ]
            }
          ],
          "outputs": {
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('app_name'))).customerId]"
            },
            "clientSecret": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('app_name')), '2020-03-01-preview').primarySharedKey]"
            },
            "envId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/kubeEnvironments', parameters('app_name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('app_name'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "appDeploy",
      "resourceGroup": "[parameters('app_name')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "app_name": {
            "value": "[parameters('app_name')]"
          },
          "storage_name": {
            "value": "[parameters('storage_name')]"
          },
          "containerAppEnvironmentId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('app_name')), 'Microsoft.Resources/deployments', 'container-app-environment')).outputs.envId.value]"
          },
          "apiImage": {
            "value": "[parameters('apiImage')]"
          },
          "webImage": {
            "value": "[parameters('webImage')]"
          },
          "registry": {
            "value": "[parameters('registry')]"
          },
          "registryUsername": {
            "value": "[parameters('registryUsername')]"
          },
          "registryPassword": {
            "value": "[parameters('registryPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "17140970344133688541"
            }
          },
          "parameters": {
            "app_name": {
              "type": "string"
            },
            "sku_storage_name": {
              "type": "string",
              "defaultValue": "Standard_LRS"
            },
            "storage_name": {
              "type": "string"
            },
            "apiImage": {
              "type": "string"
            },
            "webImage": {
              "type": "string"
            },
            "containerAppEnvironmentId": {
              "type": "string"
            },
            "registry": {
              "type": "string"
            },
            "registryUsername": {
              "type": "string"
            },
            "registryPassword": {
              "type": "secureString"
            }
          },
          "variables": {
            "rg": "[resourceGroup()]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('storage_name'), 'default', '$app')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storage_name'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storage_name'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('storage_name'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storage_name'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('storage_name')]",
              "location": "[variables('rg').location]",
              "sku": {
                "name": "[parameters('sku_storage_name')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "encryption": {
                  "keySource": "Microsoft.Storage",
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/containerApps",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}-api', parameters('app_name'))]",
              "location": "[variables('rg').location]",
              "properties": {
                "kubeEnvironmentId": "[parameters('containerAppEnvironmentId')]",
                "configuration": {
                  "ingress": {
                    "external": false,
                    "targetPort": 8080
                  },
                  "secrets": [
                    {
                      "name": "container-registry-password",
                      "value": "[parameters('registryPassword')]"
                    }
                  ],
                  "registries": [
                    {
                      "server": "[parameters('registry')]",
                      "username": "[parameters('registryUsername')]",
                      "passwordSecretRef": "container-registry-password"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[parameters('apiImage')]"
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 3
                  },
                  "dapr": {
                    "enabled": true,
                    "appPort": 8080,
                    "appId": "api"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/containerApps",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}-web', parameters('app_name'))]",
              "location": "[variables('rg').location]",
              "properties": {
                "kubeEnvironmentId": "[parameters('containerAppEnvironmentId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000
                  },
                  "secrets": [
                    {
                      "name": "container-registry-password",
                      "value": "[parameters('registryPassword')]"
                    }
                  ],
                  "registries": [
                    {
                      "server": "[parameters('registry')]",
                      "username": "[parameters('registryUsername')]",
                      "passwordSecretRef": "container-registry-password"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "image": "[parameters('webImage')]"
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 1
                  },
                  "dapr": {
                    "enabled": true,
                    "appPort": 8000,
                    "appId": "web",
                    "components": [
                      {
                        "name": "statestore",
                        "type": "state.azure.blobstorage",
                        "version": "v1",
                        "metadata": [
                          {
                            "name": "accountName",
                            "value": "[parameters('storage_name')]"
                          },
                          {
                            "name": "accountKey",
                            "secretRef": "[format('{0}', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storage_name')), '2021-06-01').keys[0].value)]"
                          },
                          {
                            "name": "containerName",
                            "value": "[format('{0}/default/$app', parameters('storage_name'))]"
                          }
                        ]
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storage_name'))]"
              ]
            }
          ],
          "outputs": {
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/containerApps', format('{0}-web', parameters('app_name')))).configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('app_name')), 'Microsoft.Resources/deployments', 'container-app-environment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('app_name'))]"
      ]
    }
  ]
}